# Chatverse

**Chatverse** — это современное бэкенд-приложение для обмена сообщениями и управления пользователями, основанное на мощной архитектуре и лучших практиках разработки программного обеспечения. Приложение спроектировано с использованием новейших технологий, чтобы обеспечить безопасность, производительность, надежность, удобство работы и **готовность к облачному развертыванию**.

## Особенности

-   **Чистая архитектура**: Приложение построено по принципам Clean Architecture, что обеспечивает четкое разделение ответственности между слоями данных, бизнес-логики и интерфейса.
-   **Обмен сообщениями**: Реализован функционал чата между пользователями с сохранением истории.
-   **Асинхронная обработка с Kafka**: Apache Kafka используется для надежной и отказоустойчивой обработки сообщений чата, обеспечивая буферизацию и гарантированную доставку.
-   **Интуитивный REST API**: Включает полный набор CRUD-операций для пользователей и эндпоинты для управления чатом.
-   **JWT-аутентификация**: Для обеспечения безопасности используются современные методы работы с токенами (JWT) и авторизационные механизмы, включая refresh-токены.
-   **Документация Swagger**: Подключена автоматическая документация SpringDoc OpenAPI (Swagger UI), упрощающая изучение API и интеграцию.
-   **Поддержка современных стандартов**: Приложение использует актуальные версии Spring Boot, Spring Security, Kafka, Redis и другие библиотеки.
-   **Готовность к Kubernetes**: Приложение контейнеризировано с помощью Docker и подготовлено для развертывания в среде Kubernetes.
-   **CI/CD**: Настроен (или готов к настройке) конвейер непрерывной интеграции и доставки для автоматизации сборки, тестирования и развертывания.

## Использованные технологии

-   **Java 17**: Новый стандарт для повышения производительности и читаемости кода.
-   **Spring Boot 3.3.1**: Для удобной разработки и управления зависимостями.
-   **Spring Security**: Современная реализация безопасности API с JWT.
-   **Apache Kafka**: Для надежной асинхронной обработки сообщений чата.
-   **Redis**: Для управления refresh-токенами (и потенциально для кэширования/сессий).
-   **Spring Data JPA / Hibernate**: Для работы с реляционной базой данных (PostgreSQL).
-   **PostgreSQL**: Высокопроизводительная и масштабируемая реляционная база данных.
-   **Lombok**: Уменьшает шаблонный код за счет аннотаций.
-   **SpringDoc OpenAPI**: Генерация документации API для Swagger UI.
-   **WebSocket Support (via Spring Messaging)**: Интеграция для будущей реализации доставки сообщений в реальном времени. *(Примечание: Активная доставка через WebSocket может быть еще в разработке)*.
-   **Docker**: Для контейнеризации приложения и его зависимостей.
-   **Kubernetes**: Для оркестрации контейнеров и развертывания в облачных или on-premise средах.
-   **CI/CD Tools (e.g., Jenkins, GitLab CI, GitHub Actions)**: Для автоматизации процессов разработки и развертывания. *(Уточните конкретный инструмент, если он уже выбран)*

## Основные функции

### Регистрация и аутентификация

-   **Регистрация нового пользователя**: Простая и безопасная система создания учетных записей с валидацией входных данных.
-   **Авторизация через коды**: Система отправки одноразового кода для подтверждения номера телефона.
-   **Обновление токенов**: Использование `refresh-token` (хранящихся в Redis) для безопасного продления сеансов.
-   **Проверка JWT**: Эндпоинт для валидации текущего access-токена.

### Управление пользователями

-   **CRUD-операции**:
    -   Получение данных текущего пользователя.
    -   Обновление профиля пользователя.
    -   Удаление пользователя из системы.

### Чат

-   **Отправка сообщений**: Отправка текстовых сообщений между пользователями.
-   **Получение истории сообщений**: Загрузка истории переписки для конкретного чата (комнаты).
-   **Обработка сообщений через Kafka**: Сообщения буферизуются и обрабатываются асинхронно с помощью Kafka, сохраняясь в PostgreSQL.
-   **(Планируется) Доставка в реальном времени через WebSocket**: Отображение сообщений у получателей без перезагрузки страницы.

### Онлайн-статус и аналитика

-   Поддержка флага онлайн-активности для пользователей (базовая).
-   Отображение времени последнего входа (базовое).

## API

Каждая конечная точка API задокументирована в Swagger UI, доступном по пути:
`http://localhost:8888/swagger-ui/index.html` (или порт, указанный в `docker-compose.yml` для локального запуска)

### Пример конечных точек

-   `POST /api/v1/users/send-auth-code` — Отправка одноразового кода.
-   `POST /api/v1/users/check-auth-code` — Проверка кода и аутентификация.
-   `POST /api/v1/users/refresh-token` — Обновление токенов.
-   `GET /api/v1/users/check-jwt` — Проверка валидности текущего токена.
-   `GET /api/v1/users/me` — Получение профиля текущего пользователя.
-   `PUT /api/v1/users/me` — Обновление данных профиля.
-   `POST /api/v1/chat/messages` — Отправка нового сообщения в чат.
-   `GET /api/v1/chat/messages/{roomId}` — Получение истории сообщений для чата.

## Архитектурные принципы

-   **Четкое разделение логики**: Использование DI (Spring) для управления зависимостями и принципов Clean Architecture.
-   **Асинхронность и отказоустойчивость**: Использование Kafka для decoupling'а и надежной обработки сообщений.
-   **Тестирование**: Поддержка unit и интеграционных тестов для всех слоев приложения.
-   **Гибкость и расширяемость**: Возможность легкого добавления новых функций и улучшений.
-   **Контейнеризация и оркестрация**: Готовность к развертыванию и масштабированию с помощью Docker и Kubernetes.
-   **Автоматизация**: Использование CI/CD для ускорения и повышения надежности цикла разработки.

## Запуск и Развертывание

### Локальный запуск (для разработки)

**Требования:**

*   **WSL (Windows Subsystem for Linux) или Linux-подобная среда**: Для выполнения bash-скриптов.
*   **Docker и Docker Compose**: Установленные и настроенные в вашей среде WSL/Linux.

**Шаги:**

1.  **Склонируйте репозиторий**:
```bash
    git clone git@github.com:mike-shukra/chatverse.git
```
2.  **(Опционально) Предоставьте права на выполнение скриптам**:
    Если скрипты для запуска/остановки еще не имеют прав на выполнение, добавьте их:
```bash
chmod +x ./k8s/deploy.sh
chmod +x ./k8s/debug-resource.sh # Для сохранения логов
chmod +x ./k8s/check-health-standalone.sh # Проверка состояния контейнеров
```

3.  **Запустите окружение с помощью скрипта**:
    Используйте предоставленный bash-скрипт для запуска всех необходимых сервисов (приложение, PostgreSQL, Kafka, Redis) через Docker Compose.
 
4.  **Проверьте доступность**:
    *   **Swagger UI**: Откройте в браузере http://localhost:8888/swagger-ui/index.html (или порт, указанный в конфигурации).
    *   У вас может быть доступ через node port к nginx контроллеру, или вы можете сделать проброс порта, если используете WSL
    ```bash
    kubectl port-forward -n ingress-nginx svc/ingress-nginx-controller 8888:80
    ```
    *   **Логи**: Проверьте логи контейнеров при необходимости:

```bash
    kubectl get pods -n chatverse
    kubectl logs -n chatverse <имя контейнера>
```
```bash 
    docker-compose logs -f app # Логи приложения
    docker-compose logs -f kafka # Логи Kafka
    # и т.д. для других сервисов
``` 

### Развертывание в Kubernetes

1.  Приложение содержит необходимые Dockerfile для сборки контейнера.
2.  В репозитории (или будут добавлены, или изменены) присутствуют манифесты Kubernetes (deployment.yaml, service.yaml, configmap.yaml, secret.yaml и т.д.) для развертывания приложения и его зависимостей (PostgreSQL, Kafka, Redis) в кластере Kubernetes.
3.  Развертывание осуществляется с помощью kubectl apply -f <путь_к_манифестам> или через инструменты CI/CD (Helm, Argo CD и т.п.).

### CI/CD

-   Проект использует (или готов к интеграции) CI/CD пайплайн.
-   Основные шаги пайплайна включают:
    -   Сборка проекта (Maven/Gradle).
    -   Запуск тестов (unit, интеграционные).
    -   Сборка Docker-образа.
    -   Публикация образа в Docker Registry.
    -   Развертывание новой версии в среде Kubernetes (staging/production).